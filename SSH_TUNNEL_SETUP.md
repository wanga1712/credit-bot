# Настройка SSH туннеля для Telegram бота

## Проблема
Сервер не может подключиться к Telegram API, но у вас есть прямой SSH доступ к серверу с ноутбука, который может подключиться к Telegram.

## Решение: SSH туннель с SOCKS5 прокси

### Шаг 1: Создание SSH туннеля на ноутбуке (Windows)

Откройте PowerShell или CMD на вашем ноутбуке и выполните:

```powershell
ssh -D 1080 -N wanga@100.122.104.106
```

**Объяснение:**
- `-D 1080` - создает SOCKS5 прокси на локальном порту 1080
- `-N` - не выполняет команды, только туннель
- `wanga@100.122.104.106` - ваш пользователь и адрес сервера

**Важно:** Оставьте это окно открытым! Туннель работает пока открыто это окно.

### Шаг 2: Настройка бота на сервере

На сервере отредактируйте файл `.env`:

```bash
cd ~/credit-bot
nano .env
```

Добавьте или измените строку:
```bash
TELEGRAM_PROXY=socks5://127.0.0.1:1080
```

**Важно:** Используйте `127.0.0.1:1080`, так как с точки зрения сервера SSH туннель выглядит как локальный прокси.

### Шаг 3: Проверка подключения

На сервере запустите:

```bash
python check_telegram_connection.py
```

Если все настроено правильно, вы увидите:
```
✅ Подключение успешно!
✅ Токен валиден!
```

### Шаг 4: Запуск бота

Если проверка успешна, запустите бота:

```bash
python main.py
```

## Альтернатива: Постоянный туннель через systemd (Linux)

Если хотите, чтобы туннель работал постоянно без открытого окна на ноутбуке, можно настроить автотуннель на сервере.

### Вариант A: Использование autossh

1. Установите autossh на сервере:
```bash
sudo apt install autossh
```

2. Создайте systemd service:
```bash
sudo nano /etc/systemd/system/telegram-proxy-tunnel.service
```

3. Добавьте конфигурацию:
```ini
[Unit]
Description=SSH Tunnel for Telegram Bot
After=network.target

[Service]
Type=simple
User=wanga
ExecStart=/usr/bin/autossh -M 0 -f -N -D 1080 -o ServerAliveInterval=60 -o ServerAliveCountMax=3 wanga@100.122.104.106
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

4. Запустите сервис:
```bash
sudo systemctl daemon-reload
sudo systemctl enable telegram-proxy-tunnel
sudo systemctl start telegram-proxy-tunnel
```

**Примечание:** Для этого варианта нужен SSH доступ с сервера обратно на ноутбук, что может быть сложнее настроить.

## Устранение проблем

### Проблема: "Connection refused" при использовании прокси

**Решение:** Убедитесь, что SSH туннель запущен на ноутбуке и порт 1080 доступен.

### Проблема: Туннель обрывается

**Решение:** Используйте autossh или добавьте в SSH команду:
```powershell
ssh -D 1080 -N -o ServerAliveInterval=60 -o ServerAliveCountMax=3 wanga@100.122.104.106
```

### Проблема: Прокси не работает

**Решение:** Проверьте, что на ноутбуке нет файрвола, блокирующего порт 1080.

## Проверка работы туннеля

На сервере проверьте, что порт 1080 слушается:

```bash
netstat -tuln | grep 1080
# или
ss -tuln | grep 1080
```

Если порт не слушается, туннель не создан или не работает.

